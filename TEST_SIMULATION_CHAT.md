# 模拟对话功能测试指南

## 修复内容

### 问题 1：教案同步延迟
- **原因**：教案更新有 500ms 防抖延迟，导致快速发送消息时教案未同步
- **修复**：在发送消息前立即同步教案到父组件

### 问题 2：静默失败无反馈
- **原因**：缺少 API 配置、学生画像或教案时，只是静默返回
- **修复**：添加了友好的错误提示消息

## 测试步骤

### 1. 启动开发服务器
```bash
cd code
npm run dev
```

### 2. 访问工坊页面
打开浏览器访问：http://localhost:3000/workshop

### 3. 测试场景 A：正常流程
1. 进入步骤 3（模拟课堂）
2. 在"教案内容"输入框中输入任意教案内容，例如：
   ```
   教学目标：理解光合作用的基本原理
   教学重点：光合作用的过程
   ```
3. 选择一个学生画像（例如：学生A）
4. 在聊天框中输入消息："你好，今天我们来学习光合作用"
5. 点击发送按钮
6. **预期结果**：应该看到学生的回复

### 4. 测试场景 B：缺少 API 配置
1. 清除浏览器 localStorage（F12 → Application → Local Storage → Clear）
2. 刷新页面
3. 输入教案和选择学生画像
4. 发送消息
5. **预期结果**：应该看到错误提示"请先配置 API 设置后再开始对话"

### 5. 测试场景 C：缺少学生画像
1. 输入教案内容
2. 不选择学生画像
3. **预期结果**：聊天界面不应该显示（会显示提示"请先输入教案内容并选择学生画像"）

### 6. 测试场景 D：缺少教案
1. 不输入教案内容
2. 选择学生画像
3. **预期结果**：聊天界面不应该显示

### 7. 测试场景 E：快速发送（测试同步修复）
1. 输入教案内容
2. 选择学生画像
3. **立即**（不等待）发送消息
4. **预期结果**：消息应该正常发送，不会因为教案未同步而失败

## 调试技巧

### 查看控制台日志
打开浏览器控制台（F12），查看以下日志：
- `[Workshop] Lesson plan set` - 教案已保存
- `[Workshop] Student profile set` - 学生画像已选择
- `[Workshop] Message sent` - 消息已发送
- `[Workshop] API config not set` - API 未配置
- `[Workshop] No student profile selected` - 未选择学生画像
- `[Workshop] No lesson plan provided` - 未提供教案

### 检查 localStorage
在控制台中运行：
```javascript
// 查看当前会话
JSON.parse(localStorage.getItem('research-sessions'))

// 查看 API 配置
JSON.parse(localStorage.getItem('api-config'))
```

## 修复的文件

1. `code/app/workshop/page.tsx`
   - 添加了错误消息反馈
   - 在检查失败时显示友好提示

2. `code/components/step-panels/step3-simulation.tsx`
   - 添加了 `handleSendMessage` 包装函数
   - 确保发送前教案已同步
   - 优化了教案同步逻辑

## 常见问题

### Q: 点击发送后没有任何反应
A: 检查以下几点：
1. 是否配置了 API（点击右上角设置按钮）
2. 是否输入了教案内容
3. 是否选择了学生画像
4. 查看控制台是否有错误日志

### Q: 看到错误提示但不知道怎么办
A: 根据错误提示操作：
- "请先配置 API 设置" → 点击右上角设置按钮配置 API
- "请先选择一个学生画像" → 在学生画像选择区域选择一个学生
- "请先输入教案内容" → 在教案内容输入框中输入教案

### Q: 如何重置测试环境
A: 
1. 打开控制台（F12）
2. 运行：`localStorage.clear()`
3. 刷新页面

## 成功标准

✅ 输入教案和选择学生画像后，能够正常发送和接收消息
✅ 缺少必要信息时，显示清晰的错误提示
✅ 快速发送消息时不会因为同步延迟而失败
✅ 控制台没有未处理的错误
